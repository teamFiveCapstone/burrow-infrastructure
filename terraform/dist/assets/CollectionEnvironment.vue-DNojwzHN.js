import{d as L,B as G,r as V,R as T,E as R,f as $,o as ne,b as g,S as f,e as u,c as P,aX as K,Z as W,U as Q,X as Y,x as te,aV as X,aR as Z,at as se,h as n,g as ee,T as U,n as oe,aZ as ae,a_ as ie,a6 as J,ah as re,A as ce,a9 as D,j as p,ao as ue,aI as ve,t as de,a0 as me,af as q}from"./index-D7a02O2S.js";import{w as fe}from"./DeleteSidebarListElement.vue-BFxO_Qyx.js";import{C as pe}from"./EditSidebarListElement.vue-Cjpri2Sx.js";import{b as he}from"./ViewLayoutSection.vue-vG1nOkC2.js";import{J as be,M as ke}from"./EnvironmentModal.vue-Bc6VMQ5i.js";import{x as H,H as xe}from"./DataTableHeader.vue-D8DUf1pr.js";import"./CommandActionInput.vue-CM6RavLv.js";const ye=L({__name:"EnvironmentForm",props:{collection:{},environment:{},workspace:{},envVariables:{}},setup(r){const{collectionMutators:t}=G(),o=V([]),z=V(new Set),k=V(new Map),h=V(!1),_=T(()=>{if(!r.environment?.value)return[{key:"",value:""}];try{const e=JSON.parse(r.environment.value),l=Object.entries(e).map(([s,a])=>({key:s,value:String(a)}));return l.length===0?[{key:"",value:""}]:l}catch{return[{key:"",value:""}]}}),E=T(()=>{const e=o.value[o.value.length-1];return e?e.key||e.value?[...o.value,{key:"",value:""}]:o.value:[{key:"",value:""}]}),w=T(()=>{const e=new Map;return o.value.forEach((l,s)=>{if(l.key){const a=e.get(l.key)||[];a.push(s),e.set(l.key,a)}}),k.value.forEach((l,s)=>{if(l){const a=e.get(l)||[];a.push(s),e.set(l,a)}}),Array.from(e.values()).filter(l=>l.length>1).flat()});R(_,e=>{o.value=[...e],z.value=new Set(e.map(l=>l.key).filter(Boolean))},{immediate:!0});const M=async(e,l,s)=>{if(!h.value){if(l==="key"){k.value.set(e,s);const a=new Set(z.value),d=o.value[e];if(d&&a.delete(d.key),a.has(s))return}h.value=!0;try{const a=[...o.value],d=a[e];if(!d)return;a[e]={key:l==="key"?s:d.key,value:l==="value"?s:d.value},!a[e].key&&!a[e].value&&e!==a.length-1&&a.splice(e,1);const S=a.reduce((b,{key:N,value:O})=>((N||O)&&(b[N]=O),b),{});if(r.collection){const b={...r.collection["x-scalar-environments"],[r.environment.name]:{...r.collection["x-scalar-environments"]?.[r.environment.name],variables:S}};await t.edit(r.collection.uid,"x-scalar-environments",b)}if(e===o.value.length-1){const b=a[a.length-1];b&&(b.key||b.value)&&await v()}await J(),o.value=a,l==="key"&&(z.value=new Set(a.map(b=>b.key).filter(Boolean)),k.value.delete(e))}finally{h.value=!1}}},v=async()=>{if(!h.value){h.value=!0;try{const e=[...o.value,{key:"",value:""}],l=e.reduce((s,{key:a,value:d})=>((a||d)&&(s[a]=d),s),{});if(r.collection){const s={...r.collection["x-scalar-environments"],[r.environment.name]:{...r.collection["x-scalar-environments"]?.[r.environment.name],variables:l}};await t.edit(r.collection.uid,"x-scalar-environments",s)}await J(),o.value=e}finally{h.value=!1}}},F=async e=>{if(!h.value){h.value=!0;try{const l=[...o.value];l.splice(e,1);const s=l.reduce((a,{key:d,value:S})=>((d||S)&&(a[d]=S),a),{});if(r.collection){const a={...r.collection["x-scalar-environments"],[r.environment.name]:{...r.collection["x-scalar-environments"]?.[r.environment.name],variables:s}};await t.edit(r.collection.uid,"x-scalar-environments",a)}await J(),o.value=l}finally{h.value=!1}}},I=async()=>{if(o.value.length===0)await v();else if(o.value.length>=1){const e=o.value[o.value.length-1];e&&(e.key||e.value)&&await v()}};return ne(()=>{I()}),R(()=>o.value,()=>{I()}),(e,l)=>(g(),$(ie,{class:"group/table flex-1",columns:["",""]},{default:f(()=>[u(K,{class:"sr-only !block"},{default:f(()=>[u(H,null,{default:f(()=>[...l[0]||(l[0]=[W("Key",-1)])]),_:1}),u(H,null,{default:f(()=>[...l[1]||(l[1]=[W("Value",-1)])]),_:1})]),_:1}),(g(!0),P(Q,null,Y(E.value,(s,a)=>(g(),$(K,{key:a,class:te({error:w.value.includes(a)})},{default:f(()=>[u(X,null,{default:f(()=>[u(Z,{disableCloseBrackets:"",disableEnter:"",disableTabIndent:"",lineWrapping:"",environment:e.environment,envVariables:e.envVariables,modelValue:s.key,placeholder:"Key",workspace:e.workspace,"onUpdate:modelValue":d=>M(a,"key",d)},se({_:2},[w.value.includes(a)?{name:"icon",fn:f(()=>[u(n(xe),{class:"text-red mr-0.75 size-3.5 brightness-[.9]"})]),key:"0"}:void 0]),1032,["environment","envVariables","modelValue","workspace","onUpdate:modelValue"])]),_:2},1024),u(X,null,{default:f(()=>[u(Z,{class:"pr-6 group-hover:pr-10 group-has-[.cm-focused]:pr-10",disableCloseBrackets:"",disableEnter:"",disableTabIndent:"",lineWrapping:"",environment:e.environment,envVariables:e.envVariables,modelValue:s.value,placeholder:"Value",workspace:e.workspace,"onUpdate:modelValue":d=>M(a,"value",d)},{icon:f(()=>[s.key||s.value?(g(),$(n(U),{key:0,class:"text-c-2 hover:text-c-1 hover:bg-b-2 z-context hidden h-fit rounded p-1 group-hover:flex group-has-[.cm-focused]:flex",size:"sm",variant:"ghost",onClick:oe(d=>F(a),["stop"])},{default:f(()=>[u(n(ae),{class:"size-3.5"})]),_:1},8,["onClick"])):ee("",!0)]),_:2},1032,["environment","envVariables","modelValue","workspace","onUpdate:modelValue"])]),_:2},1024)]),_:2},1032,["class"]))),128))]),_:1}))}}),ge=re(ye,[["__scopeId","data-v-83bfcc8a"]]),we={class:"flex h-full w-full flex-col gap-12 px-1.5 pt-8"},Ce={class:"flex flex-col gap-4"},Ve={class:"rounded-lg border"},_e={class:"bg-b-2 flex cursor-grab items-center justify-between rounded-t-lg px-1 py-1 text-sm"},Ee={class:"flex items-center"},Fe=["onClick"],Se={class:"text-c-3 flex h-full items-center justify-center rounded-lg border p-4"},Oe=L({__name:"CollectionEnvironment",setup(r){const{activeCollection:t,activeWorkspace:o,activeEnvVariables:z}=ce(),{collectionMutators:k}=G(),h=D(),_=D(),E=D(),w=D(),M=V(""),v=V(null),F=V(void 0),I=T(()=>t.value?.["x-scalar-environments"]?Object.entries(t.value["x-scalar-environments"]).map(([c,i])=>({uid:c,name:c,value:JSON.stringify(i.variables||{}),color:i.color||"#FFFFFF"})):[]),e=()=>{!t.value?.uid||!v.value||(k.removeEnvironment(v.value,t.value.uid),_.hide())},l=c=>{v.value=c,_.show()},s=c=>{t.value?.uid&&(k.addEnvironment(c.name,{variables:{},color:c.color},t.value.uid),E.hide())},a=c=>{v.value=c.name,M.value=c.color||"#FFFFFF",h.show()},d=c=>{if(!t.value?.uid||!v.value)return;const i={...t.value["x-scalar-environments"],[v.value]:{variables:t.value["x-scalar-environments"]?.[v.value]?.variables||{},color:c}};k.edit(t.value.uid,"x-scalar-environments",i),h.hide()},S=c=>{v.value=c,F.value=c,w.show()},b=()=>{v.value=null,F.value=void 0,w.hide()},N=c=>{if(!t.value?.uid||!v.value)return;const i={...t.value["x-scalar-environments"]};if(!i[v.value])return;const m={},x=Object.entries(i),y=x.findIndex(([C])=>C===v.value);x.forEach(([C,j],A)=>{A===y?m[c]=j:m[C]=j}),k.edit(t.value.uid,"x-scalar-environments",m),v.value=null,F.value=void 0,w.hide()},O=(c,i)=>{if(!t.value?.uid)return;const m={...t.value["x-scalar-environments"]},x={},y=Object.entries(m),C=y.findIndex(([B])=>B===c.id),j=y.findIndex(([B])=>B===i.id);if(C===-1||j===-1)return;const A=y[C];A&&(y.splice(C,1),y.splice(j,0,A),y.forEach(([B,le])=>{x[B]=le}),k.edit(t.value.uid,"x-scalar-environments",x))};return(c,i)=>(g(),$(he,null,{default:f(()=>[p("div",we,[p("div",Ce,[i[5]||(i[5]=p("div",{class:"flex items-start justify-between gap-2"},[p("div",{class:"flex flex-col gap-2"},[p("div",{class:"flex h-8 items-center"},[p("h3",{class:"font-bold"},"Environment Variables")]),p("p",{class:"text-sm"},[W(" Set environment variables at your collection level. Use "),p("code",{class:"font-code text-c-2"},"{{ variable }}"),W(" to add / search among the selected environment's variables in your request inputs. ")])])],-1)),(g(!0),P(Q,null,Y(I.value,m=>(g(),$(n(ue),{key:m.name,id:m.name,isDraggable:!0,isDroppable:!0,parentIds:[],onOnDragEnd:O},{default:f(()=>[p("div",Ve,[p("div",_e,[p("div",Ee,[u(n(U),{class:"hover:bg-b-3 flex h-6 w-6 p-1",onClick:x=>a(m),variant:"ghost"},{default:f(()=>[p("span",{style:ve({backgroundColor:m.color||"#FFFFFF"}),class:"h-2.5 w-2.5 rounded-full"},null,4)]),_:2},1032,["onClick"]),p("button",{class:"hover:bg-b-3 rounded px-1 py-0.5 text-sm",onClick:x=>S(m.name)},de(m.name),9,Fe)]),u(n(U),{class:"hover:bg-b-3 hover:text-c-1 h-fit p-1.25",variant:"ghost",onClick:x=>l(m.name)},{default:f(()=>[u(n(ae),{class:"size-3.5"})]),_:1},8,["onClick"])]),n(t)&&n(o)?(g(),$(ge,{key:0,collection:n(t),environment:m,envVariables:n(z),workspace:n(o)},null,8,["collection","environment","envVariables","workspace"])):ee("",!0)])]),_:2},1032,["id"]))),128)),p("div",Se,[u(n(U),{class:"hover:bg-b-2 hover:text-c-1 flex items-center gap-2",size:"sm",variant:"ghost",onClick:i[0]||(i[0]=m=>n(E).show())},{default:f(()=>[u(n(me),{class:"inline-flex",icon:"Add",size:"sm",thickness:"1.5"}),i[4]||(i[4]=p("span",null,"Add Environment",-1))]),_:1})])]),u(n(q),{size:"xxs",state:n(_),title:`Delete ${v.value||"Environment"}`},{default:f(()=>[u(fe,{variableName:"Environment",warningMessage:"Are you sure you want to delete this environment? This action cannot be undone.",onClose:i[1]||(i[1]=m=>n(_).hide()),onDelete:e})]),_:1},8,["state","title"]),u(be,{activeWorkspaceCollections:n(t)?[n(t)]:[],collectionId:n(t)?.uid,state:n(E),onCancel:i[2]||(i[2]=m=>n(E).hide()),onSubmit:s},null,8,["activeWorkspaceCollections","collectionId","state"]),u(ke,{selectedColor:M.value,state:n(h),onCancel:i[3]||(i[3]=m=>n(h).hide()),onSubmit:d},null,8,["selectedColor","state"]),u(n(q),{size:"xxs",state:n(w),title:`Edit ${v.value}`},{default:f(()=>[u(pe,{name:F.value??"",onClose:b,onEdit:N},null,8,["name"])]),_:1},8,["state","title"])])]),_:1}))}});export{Oe as default};
